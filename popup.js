document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("downloadBtn"),t=document.getElementById("cancelBtn"),n=document.getElementById("status"),o=document.getElementById("progressBar"),r=document.getElementById("progressText"),s=document.querySelector(".progress"),i=document.getElementById("logArea"),d=document.getElementById("verifyLicenseBtn"),a=document.getElementById("licenseKeyInput");let l=!1;function c(e,t){n.textContent=e,n.className=`status ${t}`,n.style.display="block"}function m(e){const t=document.createElement("div");t.className="log-entry",t.textContent=e,i.appendChild(t),i.scrollTop=i.scrollHeight}chrome.storage.local.get("licenseVerified",(t=>{t.licenseVerified?(l=!0,e.disabled=!1,d.disabled=!0,a.disabled=!0,c("License already verified.","success"),m("✅ License already verified.")):(l=!1,e.disabled=!1,c("License not verified. Limited to 50 pins. Email extenhive@gmail.com to purchase a license for unlimited downloads.","error"),m("❌ License not verified. Limited download. Email extenhive@gmail.com to purchase a license for unlimited downloads."))})),e.addEventListener("click",(async()=>{try{i.innerHTML="";const[t]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=new URL(t.url).pathname.split("/").filter(Boolean),o=["search","pin","ideas","today","explore","business","notifications","messages","settings","login","signup","password-reset","about"];if(n.length<2||o.includes(n[0])||o.includes(n[1]))return void c("Please navigate to a Pinterest board first","error");s.style.display="block",e.disabled=!0,c("Starting download...","success"),m("🔍 Starting board download..."),chrome.tabs.sendMessage(t.id,{action:"startDownload",licenseVerified:l,shouldFetchVisitSite:document.getElementById("fetchVisitSite")?.checked||!1},(e=>{e&&e.error&&(c(e.error,"error"),m(`❌ Error: ${e.error}`))}))}catch(e){c("Error: "+e.message,"error"),m(`❌ Error: ${e.message}`)}})),t.addEventListener("click",(function(){chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{action:"stopDownload"})})),e.disabled=!1,e.textContent="Download Board",c("Download canceled.","error"),s.style.display="none",m("⛔ Download canceled.")})),d.addEventListener("click",(async function(){const t=a.value.trim();if(!t)return void c("Please enter a license key.","error");c("Verifying license...","success");try{const n=await fetch("https://extenhub.com/api/verify?refresh=true",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_key:t})});(await n.json()).valid?(c("License verified! You can now download unlimited.","success"),e.disabled=!1,d.disabled=!0,a.disabled=!0,m("✅ License verified."),l=!0,chrome.storage.local.set({licenseVerified:!0})):(c("Invalid or expired license.","error"),e.disabled=!1,l=!1,chrome.storage.local.set({licenseVerified:!1}),m("❌ License verification failed."))}catch(e){console.error(e),c("Error verifying license.","error"),m(`Error: ${e.message}`)}})),chrome.runtime.onMessage.addListener((t=>{"log"===t.type?m(t.message):"progress"===t.type?(s.style.display="block",o.value=t.progress,r.textContent=`${t.progress.toFixed(1)}%`):"complete"===t.type?(c("Download complete!","success"),e.disabled=!1,e.textContent="Download Board",s.style.display="none",m(t.message)):"error"===t.type&&(c(t.error,"error"),e.disabled=!1,e.textContent="Download Board",s.style.display="none",m(`Error: ${t.error}`))}))}));